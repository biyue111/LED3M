// Header: 8*8cube driver
// File Name: drive
// Author: 毕越
// Date：2014,4,22
#include<reg52.h>

sbit LE0=P2^0;	         //控制74HC573所存的管脚
sbit LE1=P2^1;	         //控制74HC573所存的管脚
sbit LE2=P2^2;	         //控制74HC573所存的管脚
sbit LE3=P2^3;	         //控制74HC573所存的管脚
sbit LE4=P2^4;	         //控制74HC573所存的管脚
sbit LE5=P2^5;	         //控制74HC573所存的管脚
sbit LE6=P2^6;	         //控制74HC573所存的管脚
sbit LE7=P2^7;	         //控制74HC573所存的管脚

						
unsigned char frame;     //控制画面的帧数
unsigned char i=0,row=0x80;
unsigned char clear[8]={0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
//存储显示的画面

unsigned char code led1[8][8]=
{ //第1个画面
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00},
{0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
},
code led2[8][8]=
{ //第2个画面
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x3C,0x3C,0x3C,0x3C,0x00,0x00},
{0x00,0x00,0x3C,0x3C,0x3C,0x3C,0x00,0x00},
{0x00,0x00,0x3C,0x3C,0x3C,0x3C,0x00,0x00},
{0x00,0x00,0x3C,0x3C,0x3C,0x3C,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
},
code led3[8][8]=
{ //第3个画面
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00},
{0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00},
{0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00},
{0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00},
{0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00},
{0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
},
code led4[8][8]=
{ //第4个画面
{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF}
},
code led5[8][8]=
{ //第5个画面
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00},
{0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00},
{0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00},
{0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00},
{0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00},
{0x00,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
},
code led6[8][8]=
{ //第6个画面
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x3C,0x3C,0x3C,0x3C,0x00,0x00},
{0x00,0x00,0x3C,0x3C,0x3C,0x3C,0x00,0x00},
{0x00,0x00,0x3C,0x3C,0x3C,0x3C,0x00,0x00},
{0x00,0x00,0x3C,0x3C,0x3C,0x3C,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
},
code led7[8][8]=
{ //第7个画面
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00},
{0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
},
code led8[8][8]=
{ //第8个画面
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}
},

code led9[8][8]=
{	//第6个画面
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF}
};
unsigned char  (code *ptr[9])[8]; //指向xdata的指针变量
/*
{
//动画
{0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x80},
{0x02,0x03,0x00,0x00,0x00,0x00,0xC0,0x40},
{0x05,0x04,0x07,0x00,0x00,0xE0,0x20,0xA0},
{0x0A,0x0B,0x08,0x0F,0xF0,0x10,0xD0,0x50},
{0x15,0x14,0x17,0xF8,0x1F,0xE8,0x28,0xA8},
{0x2A,0x2B,0xFC,0x2F,0xF4,0x3F,0xD4,0x54},
{0x55,0xFE,0x57,0xFA,0x5F,0xEA,0x7F,0xAA},
{0xFF,0xAB,0xFD,0xAF,0xF5,0xBF,0xD5,0xFF} 	 
}
};	

			
unsigned char xdata led2[][8][8]={
{0xAA,0x2B,0xE8,0x1F,0xF8,0x17,0xD4,0x55},	//
{0x55,0xD4,0x17,0xF8,0x1F,0xE8,0x2B,0xAA},	//
{0x5A,0xA5,0x66,0x99,0x99,0x66,0xA5,0x5A},	//
{0x24,0x18,0x99,0x7E,0x7E,0x99,0x18,0x24},	//
{0x42,0xDB,0x24,0x5A,0x5A,0x24,0xDB,0x42},	//
{0x00,0x66,0xff,0xff,0x7e,0x3c,0x18,0x00},	//
{0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff}	//
};
*/ 

void DelayDemims(unsigned int);			   // 延时函数 延时半毫秒
void ShiftIt(unsigned char,unsigned char[]); //把显示的一行图案发送给芯片
											  
void main()
{
	//指针变量初始化
	ptr[0]=led1;
	ptr[1]=led2;
	ptr[2]=led3;
	ptr[3]=led4;
	ptr[4]=led5;
	ptr[5]=led6;
	ptr[6]=led7;
	ptr[7]=led8;
	ptr[8]=led9;

	//定时器初始化
	TMOD = 0x01;             //设置M0，M1=0，1 为16位
	TH0 = (65536-1433)/256; //装初始值，设置定时器中断时长为12.5ms
	TL0 = (65532-1433)%256; //同上
	EA = 1;                  //打开中断总开关
	ET0 = 1;                 //开定时器0中断
	TR0 = 1;                 //启动定时器0

	//管脚初始化
	P1 = 0x00;
	P0 = 0xff;

	
	frame = 0 ;        //帧数初始化
	while(1)
	{
		if (frame < 7) //从第一到第八帧循环
		{
			frame++;
		}
		else 
		{
			frame=0;
		}
		DelayDemims(1000); //确定每一帧的时长
	}

}					  
/*******************************************************
函数名：ShiftIt
功能：把8片中的8行（row）行图案发送给8个芯片
（row中为1的那一行如：0100000）
********************************************************/
void ShiftIt(unsigned char row,unsigned char *cc)
{
	P0=row;
	
	LE0=1;  //解锁74HC573
	P1=*(cc+0);	 //传输图案		
	LE0=0;  //锁定74HC573
	P1=0x00; //消影

	LE1=1;  //解锁74HC573
	P1=*(cc+1);	 //传输图案
	LE1=0;  //锁定74HC573
	P1=0x00; //消影

	LE2=1;  //解锁74HC573
	P1=*(cc+2);	 //传输图案
	LE2=0;  //锁定74HC573
	P1=0x00; //消影

	LE3=1;  //解锁74HC573
	P1=*(cc+3);	 //传输图案
	LE3=0;  //锁定74HC573
	P1=0x00; //消影

	LE4=1;  //解锁74HC573
	P1=*(cc+4);	 //传输图案
	LE4=0;  //锁定74HC573
	P1=0x00; //消影

	LE5=1;  //解锁74HC573
	P1=*(cc+5);	 //传输图案
	LE5=0;  //锁定74HC573
	P1=0x00; //消影

	LE6=1;  //解锁74HC573
	P1=*(cc+6);	 //传输图案
	LE6=0;  //锁定74HC573
	P1=0x00; //消影

	LE7=1;  //解锁74HC573
	P1=*(cc+7);	 //传输图案
	LE7=0;  //锁定74HC573
	P1=0x00; //消影

	//DelayDemims(8); //停留半秒
}
/*******************************************************
函数名：DelayDemime
功能：在11.0592MHz晶振下延时半毫秒
********************************************************/
void DelayDemims(unsigned int a)
{
	unsigned int j;
	unsigned char i;
	for (j=a;j>0;j--)																								   
	{
		for (i=55;i>0;i--);
	}	
}
/*******************************************************
函数名：Timer1（中断函数）
功能：在11.0592MHz晶振下每隔12.5毫秒扫描一次点阵
********************************************************/ 
void Timer1() interrupt 1
{
	
	TH0=(65536-1433)/256;          //装初始值
	TL0=(65532-1433)%256;

	ShiftIt(0x00,clear); //熄灭全部消影

	if (row<1)
	{
		row=0x80;
	}
	else 
	{
		row=row >> 1;
	}

	if (i>7)
	{
		i = 0;
	}
	else 
	{
		i++;
	}

	ShiftIt(row,*(ptr[frame]+i)); //点亮本行 led[frame][i]

					
}		    